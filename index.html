<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
</head>

<body>
  <button onclick="fff()">点击触发</button>
  <h3></h3>
</body>
<script>
  const md = window.markdownit();
  const h3 = document.querySelector('h3')

  const fff = () => {
    const textDecoder = new TextDecoder();
    fetch('http://127.0.0.1:3002').then(res => {
      const reader = res.body.getReader()
      new ReadableStream({
        start(controller) {
          async function push() {
            const { done, value } = await reader.read()
            if (done) {
              controller.close();
              return;
            }

            // 模拟操作->替换
            // v1.0 not
            // h3.innerHTML += textDecoder.decode(value)
            // v2.0 not
            // h3.innerText += textDecoder.decode(value)
            // v3.0 work but not good
            // const text = document.createTextNode(textDecoder.decode(value))
            // h3.appendChild(text)
            // v4.0 try markdown
            const decodedValue = md.render(textDecoder.decode(value));

            // 状态机
            const state = {
              tagList: [],
              value: ''
            }
            window.state = state

            // 将解码后的文本逐个字符地添加到容器中
            for (let i = 0; i < decodedValue.length; i++) {
              requestIdleCallback(() => {
                h3.appendChild(document.createTextNode(decodedValue[i]))
                state.value += decodedValue[i]
                // 判断标签
                const match = /<\/(\w+)>/g.exec(state.value)
                // 表示已匹配到元素的结束标签
                if (match?.[0]) {
                  const lIndex = h3.textContent.lastIndexOf(`<${match[1]}`)
                  const rIndex = h3.textContent.length

                  const htmlString = h3.textContent.slice(lIndex, rIndex)
                  const template = document.createElement('template')
                  template.innerHTML = htmlString
                  for (let index = lIndex; index <= rIndex; index++) {
                    h3.childNodes[lIndex]?.remove?.()
                  }
                  h3.appendChild(template.content)
                  debugger
                }
              });
            }

            // 延时并再次调用push方法，实现延迟加载
            requestIdleCallback(push)
          }
          requestIdleCallback(push)
        }
      });
    })
  }
</script>

</html>